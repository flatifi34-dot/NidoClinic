<!DOCTYPE html>
<html lang="sq">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nido Clinic - Platforma e Plot√´</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00838f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nido Clinic">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        :root {
            /* Clean & Professional Palette */
            --primary-color: #00838f;
            --primary-dark: #006064;
            --primary-light: #e0f7fa;

            --accent-color: #d81b60;
            --accent-light: #fce4ec;

            --success-color: #2e7d32;
            --warning-color: #f57f17;
            --danger-color: #c62828;

            /* Text Colors - High Contrast */
            --text-dark: #263238;
            --text-medium: #455a64;
            --text-light: #78909c;

            /* Backgrounds */
            --bg-body: #f5f5f5;
            --bg-white: #ffffff;
            --bg-hover: #eceff1;

            /* Typography */
            --font-family: 'Outfit', sans-serif;

            /* UI Elements */
            --border-radius: 8px;
            --border-radius-large: 12px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            --shadow-md: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-body);
            color: var(--text-dark);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.5;
            font-size: 15px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: var(--bg-white);
            padding: 15px 25px;
            border-radius: var(--border-radius-large);
            margin-bottom: 25px;
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e0e0e0;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            width: 80px;
            height: auto;
            object-fit: contain;
        }

        .header-left h1 {
            color: var(--primary-color);
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 0;
            line-height: 1.2;
        }

        .header-left p {
            color: var(--text-medium);
            font-size: 0.95em;
            font-weight: 500;
        }

        .offline-badge {
            background: #e8f5e9;
            color: var(--success-color);
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #c8e6c9;
        }

        .offline-badge::before {
            content: "‚óè";
            color: var(--success-color);
            font-size: 1.2em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 240px 1fr;
            gap: 25px;
            align-items: start;
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-white);
            padding: 20px 15px;
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-sm);
            border: 1px solid #e0e0e0;
            height: fit-content;
        }

        .nav-item {
            padding: 12px 15px;
            margin: 5px 0;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-medium);
            font-weight: 500;
            font-size: 0.95em;
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--primary-color);
        }

        .nav-item.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 5px rgba(0, 131, 143, 0.3);
        }

        .data-actions {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eeeeee;
        }

        .data-actions h4 {
            color: var(--text-light);
            margin-bottom: 15px;
            font-size: 0.75em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding-left: 5px;
        }

        .content-area {
            background: var(--bg-white);
            padding: 30px;
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-sm);
            min-height: 600px;
            border: 1px solid #e0e0e0;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        h2 {
            font-size: 1.5em;
            color: var(--text-dark);
            font-weight: 700;
            margin-bottom: 20px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid #eeeeee;
            border-top: 4px solid var(--primary-color);
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
            color: var(--primary-dark);
            font-weight: 700;
        }

        .stat-card p {
            color: var(--text-medium);
            font-size: 0.9em;
            font-weight: 500;
        }

        .stat-card.warning {
            border-top-color: var(--warning-color);
        }

        .stat-card.warning h3 {
            color: var(--warning-color);
        }

        .stat-card.success {
            border-top-color: var(--success-color);
        }

        .stat-card.success h3 {
            color: var(--success-color);
        }

        .stat-card.accent {
            border-top-color: var(--accent-color);
        }

        .stat-card.accent h3 {
            color: var(--accent-color);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--primary-light);
            color: var(--primary-dark);
        }

        .btn-secondary:hover {
            background: #b2ebf2;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #1b5e20;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background: #f9a825;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #b71c1c;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8em;
        }

        /* Schedule Grid */
        .schedule-grid {
            display: grid;
            grid-template-columns: 80px repeat(5, 1fr);
            gap: 1px;
            background: #e0e0e0;
            /* Grid lines */
            border: 1px solid #e0e0e0;
            margin-top: 20px;
        }

        .day-header,
        .time-label,
        .time-slot {
            background: white;
        }

        .day-header {
            padding: 12px;
            text-align: center;
            font-weight: 600;
            background: #f5f5f5;
            color: var(--text-dark);
            font-size: 0.9em;
        }

        .time-label {
            padding: 10px;
            text-align: center;
            font-weight: 600;
            color: var(--text-medium);
            font-size: 0.85em;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafafa;
        }

        .time-slot {
            min-height: 80px;
            padding: 8px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .time-slot:hover {
            background: #e0f7fa;
        }

        .time-slot.occupied {
            background: var(--primary-light);
            cursor: grab;
            border-left: 4px solid var(--primary-color);
        }

        .time-slot.drag-over {
            background-color: #e0f7fa !important;
            border: 2px dashed var(--primary-color) !important;
        }

        .time-slot.occupied:hover {
            background: #b2ebf2;
        }

        .slot-client-name {
            font-weight: 600;
            font-size: 0.9em;
            color: var(--primary-dark);
        }

        .slot-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            background: none;
            border: none;
            color: var(--danger-color);
            font-weight: bold;
            font-size: 1.2em;
            cursor: pointer;
            width: 20px;
            height: 20px;
            line-height: 1;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .time-slot:hover .slot-remove {
            opacity: 1;
        }

        /* Payment Cards */
        .payment-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            border-left: 4px solid var(--success-color);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .payment-card.overdue {
            border-left-color: var(--danger-color);
            background: #ffebee;
        }

        .search-bar {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #bdbdbd;
            border-radius: var(--border-radius);
            font-size: 0.95em;
            margin-bottom: 20px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius-large);
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-md);
        }

        /* Profile Tabs */
        .profile-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #f0f0f0;
            flex-wrap: wrap;
        }

        .profile-tab {
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-medium);
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            font-family: inherit;
        }

        .profile-tab:hover {
            color: var(--primary-color);
            background: var(--primary-light);
        }

        .profile-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .profile-section {
            padding: 20px 0;
        }

        .profile-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .profile-form-group {
            display: flex;
            flex-direction: column;
        }

        .profile-form-group label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .profile-form-group input,
        .profile-form-group textarea,
        .profile-form-group select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.95em;
        }

        .profile-form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .session-history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .session-history-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-dark);
            border-bottom: 2px solid #ddd;
        }

        .session-history-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .progress-note {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
        }

        .progress-note-date {
            font-size: 0.85em;
            color: var(--text-medium);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .progress-note-text {
            color: var(--text-dark);
            line-height: 1.6;
        }

        .add-note-form {
            background: white;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #bdbdbd;
            border-radius: 6px;
            margin-top: 5px;
            font-family: inherit;
        }

        /* Invoice Styles - Professional & Clean */
        .invoice-modal {
            max-width: 800px !important;
            padding: 0 !important;
            overflow: hidden;
        }

        .invoice-container {
            padding: 40px;
            background: white;
            color: #333;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        .invoice-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 40px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 20px;
        }

        .invoice-logo {
            width: 100px;
            height: auto;
        }

        .invoice-title {
            text-align: right;
        }

        .invoice-title h1 {
            color: var(--primary-color);
            font-size: 2.5em;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .invoice-meta {
            margin-top: 10px;
            color: #666;
        }

        .invoice-grid {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
        }

        .invoice-to,
        .invoice-from {
            width: 45%;
        }

        .invoice-subtitle {
            font-size: 0.9em;
            text-transform: uppercase;
            color: #999;
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        .invoice-table th {
            background: #f8f9fa;
            color: #444;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85em;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #ddd;
        }

        .invoice-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            color: #555;
        }

        .invoice-table tr:last-child td {
            border-bottom: none;
        }

        .invoice-summary {
            display: flex;
            justify-content: flex-end;
        }

        .invoice-totals {
            width: 300px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .total-row.final {
            border-bottom: none;
            border-top: 2px solid var(--primary-color);
            margin-top: 10px;
            padding-top: 15px;
            font-weight: 700;
            font-size: 1.2em;
            color: var(--primary-color);
        }

        .invoice-footer {
            margin-top: 50px;
            text-align: center;
            color: #999;
            font-size: 0.85em;
            border-top: 1px solid #f0f0f0;
            padding-top: 20px;
        }

        /* Print Optimizations for Invoice */
        @media print {
            body * {
                visibility: hidden;
            }

            .invoice-container,
            .invoice-container * {
                visibility: visible;
            }

            .modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white;
                z-index: 9999;
                display: block !important;
            }

            .modal-content {
                box-shadow: none;
                border: none;
                width: 100%;
                max-width: 100%;
                padding: 0;
            }

            .invoice-actions {
                display: none !important;
            }
        }

        /* Readability Fixes */
        /* 1. Calendar Occupied Slots */
        .time-slot.occupied {
            background: var(--primary-light);
            /* Fallback */
            border: none;
            color: white !important;
            /* Force white text */
            cursor: grab;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
            /* Ensure readability on any color */
        }

        .client-avatar-small {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .slot-client-name {
            font-weight: 700;
            font-size: 1.1em;
            /* Slightly larger */
            color: white !important;
        }

        /* 2. Dashboard Cards */
        .stat-card.dark-bg h3,
        .stat-card.dark-bg p {
            color: white !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="logo.png" alt="Nido Montessori School" class="logo">

                <div class="header-left">
                    <h1>Nido Clinic</h1>
                    <p>Platforma e Terapis√´ s√´ t√´ Folurit</p>
                </div>
            </div>
            <div class="offline-badge">
                M√ãNYR√ã OFFLINE
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="nav-item active" onclick="showView('schedule')">
                    üìÖ Orari Javor
                </div>
                <div class="nav-item" onclick="showView('clients')">
                    üë• Klient√´t
                </div>
                <div class="nav-item" onclick="showView('sessions')">
                    üìù Seancat
                </div>
                <div class="nav-item" onclick="showView('payments')">
                    üí∞ Pagesat
                </div>
                <div class="nav-item" onclick="showView('dashboard')">
                    üìä Paneli
                </div>

                <div class="data-actions">
                    <h4>Menaxhimi</h4>
                    <button class="btn btn-success btn-small" onclick="exportData()"
                        style="width: 100%; margin-bottom: 10px;">
                        üíæ Rezervo
                    </button>
                    <label for="importFile"
                        style="display: inline-block; padding: 8px 15px; background: var(--primary-light); color: var(--primary-color); border-radius: 10px; cursor: pointer; font-weight: 600; width: 100%; text-align: center; box-sizing: border-box; margin-bottom: 10px;">
                        üìÇ Rikthe
                    </label>
                    <input type="file" id="importFile" accept=".json" onchange="importData(event)"
                        style="display: none;">
                </div>
            </div>

            <div class="content-area">
                <!-- Orari -->
                <div id="schedule" class="view active">
                    <div class="schedule-header">
                        <h2 style="color: var(--text-dark);">Orari Javor</h2>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-success" onclick="autoSchedule()">ü§ñ Planifiko Automatikisht</button>
                            <button class="btn btn-warning" onclick="clearSchedule()">üóëÔ∏è Pastro</button>
                            <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Printo</button>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <strong>Si funksionon:</strong> Kliko "Planifiko Automatikisht" p√´r shp√´rndarje automatike, ose
                        kliko n√´ hap√´sir√´ t√´ lir√´ p√´r t√´ zgjedhur klientin manualisht.
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card accent">
                            <h3 id="totalSlots">25</h3>
                            <p>Hap√´sira Totale</p>
                        </div>
                        <div class="stat-card success">
                            <h3 id="occupiedSlots">0</h3>
                            <p>Hap√´sira t√´ Z√´na</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="freeSlots">25</h3>
                            <p>Hap√´sira t√´ Lira</p>
                        </div>
                        <div class="stat-card warning">
                            <h3 id="utilization">0%</h3>
                            <p>P√´rdorimi</p>
                        </div>
                    </div>

                    <div class="week-navigation">
                        <button class="week-nav-btn" onclick="previousWeek()">‚Üê Java Kaluar</button>
                        <span class="current-week" id="currentWeek"></span>
                        <button class="week-nav-btn" onclick="nextWeek()">Java Tjet√´r ‚Üí</button>
                    </div>

                    <div class="schedule-grid" id="scheduleGrid"></div>

                    <div style="margin-top: 30px;">
                        <h3 style="color: var(--text-dark); margin-bottom: 15px;">Menaxho Klient√´t e Orarit</h3>
                        <button class="btn btn-primary" onclick="openAddScheduleClientModal()"
                            style="margin-bottom: 20px;">+ Shto Klient n√´ Orar</button>
                        <div id="scheduleClientsList"></div>
                    </div>
                </div>

                <!-- Klient√´t -->
                <div id="clients" class="view">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h2 style="color: var(--text-dark);">Klient√´t</h2>
                        <button class="btn btn-primary" onclick="openAddScheduleClientModal()">+ Shto Klient</button>
                    </div>
                    <div id="allClientsList"></div>
                </div>

                <!-- Seancat -->
                <div id="sessions" class="view">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h2 style="color: var(--text-dark);">Menaxhimi i Seancave</h2>
                        <button class="btn btn-primary" onclick="openAddSessionModal()">+ Shto Seanc√´</button>
                    </div>
                    <div id="sessionsList"></div>
                </div>

                <!-- Pagesat -->
                <div id="payments" class="view">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h2 style="color: var(--text-dark);">Menaxhimi i Pagesave</h2>
                    </div>

                    <div class="stats-grid" style="margin-bottom: 30px;">
                        <div class="stat-card success">
                            <h3 id="totalCollected">‚Ç¨0</h3>
                            <p>Totali i Mbledhur</p>
                        </div>
                        <div class="stat-card warning">
                            <h3 id="totalOutstanding">‚Ç¨0</h3>
                            <p>Totali i Papaguar</p>
                        </div>
                        <div class="stat-card accent">
                            <h3 id="clientsWithDebt">0</h3>
                            <p>Klient√´ me Borxh</p>
                        </div>
                    </div>

                    <input type="text" class="search-bar" id="paymentSearch" placeholder="K√´rko sipas emrit..."
                        onkeyup="filterPayments()">
                    <div id="paymentsList"></div>
                </div>

                <!-- Dashboard -->
                <div id="dashboard" class="view">
                    <h2 style="margin-bottom: 25px; color: var(--text-dark);">Paneli Kryesor</h2>
                    <div id="dashboardContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="assignClientModal" class="modal">
        <div class="modal-content">
            <h2>Cakto Klient</h2>
            <div class="form-group">
                <label>Zgjidh Klientin:</label>
                <select id="clientSelect">
                    <option value="">-- Zgjidh --</option>
                </select>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="assignClient()">Cakto</button>
                <button class="btn btn-danger" onclick="closeModal('assignClientModal')">Anulo</button>
            </div>
        </div>
    </div>

    <div id="addScheduleClientModal" class="modal">
        <div class="modal-content">
            <h2>Shto Klient n√´ Orar</h2>
            <form id="scheduleClientForm">
                <div class="form-group">
                    <label>Emri i Klientit *</label>
                    <input type="text" id="scheduleClientName" required>
                </div>
                <div class="form-group">
                    <label>Seancat n√´ Jav√´ *</label>
                    <select id="scheduleClientSessions">
                        <option value="1">1 seanc√´</option>
                        <option value="2">2 seanca</option>
                        <option value="3">3 seanca</option>
                        <option value="4" selected>4 seanca</option>
                        <option value="5">5 seanca</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Shto</button>
                    <button type="button" class="btn btn-danger"
                        onclick="closeModal('addScheduleClientModal')">Anulo</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addSessionModal" class="modal">
        <div class="modal-content">
            <h2>Shto Seanc√´</h2>
            <form id="sessionForm">
                <div class="form-group">
                    <label>Klienti *</label>
                    <select id="sessionClient" required></select>
                </div>
                <div class="form-group">
                    <label>Data *</label>
                    <input type="date" id="sessionDate" required>
                </div>
                <div class="form-group">
                    <label>Ora *</label>
                    <input type="time" id="sessionTime" required>
                </div>
                <div class="form-group">
                    <label>√ámimi *</label>
                    <div class="price-selector">
                        <label class="price-option selected" onclick="selectPrice(15)">
                            <input type="radio" name="sessionPrice" value="15" checked>
                            <div class="price">‚Ç¨15</div>
                            <div>Standard</div>
                        </label>
                        <label class="price-option" onclick="selectPrice(20)">
                            <input type="radio" name="sessionPrice" value="20">
                            <div class="price">‚Ç¨20</div>
                            <div>E Zgjeruar</div>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Sh√´nime</label>
                    <textarea id="sessionNotes"></textarea>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="sessionPaid">
                        <label for="sessionPaid" style="margin: 0;">Paguar</label>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Ruaj</button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('addSessionModal')">Anulo</button>
                </div>
            </form>
        </div>
    </div>

    <div id="invoiceModal" class="modal">
        <div class="modal-content large">
            <div style="text-align: right; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Printo</button>
                <button class="btn btn-danger" onclick="closeModal('invoiceModal')">Mbyll</button>
            </div>
            <div id="invoiceContent" class="invoice"></div>
        </div>
    </div>

    <!-- Client Profile Modal -->
    <div id="clientProfileModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="profile-picture-container"
                        style="width: 60px; height: 60px; border-radius: 50%; background: var(--bg-hover); overflow: hidden; display: flex; align-items: center; justify-content: center; border: 2px solid var(--primary-color);">
                        <span id="profile-picture-initial"
                            style="font-size: 1.5em; font-weight: bold; color: var(--primary-color);"></span>
                        <img id="profile-picture-display"
                            style="width: 100%; height: 100%; object-fit: cover; display: none;">
                    </div>
                    <h2 style="margin: 0; color: var(--primary-color);">Profili i Klientit</h2>
                </div>
                <button class="btn btn-danger" onclick="closeModal('clientProfileModal')">‚úï Mbyll</button>
            </div>

            <!-- Profile Tabs -->
            <div class="profile-tabs">
                <button class="profile-tab active" onclick="switchProfileTab('basic')">üìã Informacion Baz√´</button>
                <button class="profile-tab" onclick="switchProfileTab('medical')">üè• Mjek√´sor/Terapia</button>
                <button class="profile-tab" onclick="switchProfileTab('sessions')">üìÖ Historiku i Seancave</button>
                <button class="profile-tab" onclick="switchProfileTab('payments')">üí∞ Pagesat</button>
                <button class="profile-tab" onclick="switchProfileTab('notes')">üìù Sh√´nime</button>
            </div>

            <!-- Tab Content -->
            <div id="profileTabContent"></div>

            <div style="margin-top: 25px; text-align: right; border-top: 1px solid #f0f0f0; padding-top: 15px;">
                <button class="btn btn-primary" onclick="saveClientProfile()">üíæ Ruaj Ndryshimet</button>
                <button class="btn btn-secondary" onclick="closeModal('clientProfileModal')">Anulo</button>
            </div>
        </div>
    </div>

    <script>
        // Data
        let scheduleClients = JSON.parse(localStorage.getItem('scheduleClients')) || [
            { id: 1, name: 'Tori', sessionsPerWeek: 3, color: '#FF6B9D' },
            { id: 2, name: 'Jan A', sessionsPerWeek: 4, color: '#9C27B0' },
            { id: 3, name: 'Jan Gj', sessionsPerWeek: 4, color: '#2196F3' },
            { id: 4, name: 'Nara', sessionsPerWeek: 4, color: '#4CAF50' },
            { id: 5, name: 'Yusra', sessionsPerWeek: 4, color: '#FF9800' }
        ];

        let weeklySchedule = JSON.parse(localStorage.getItem('weeklySchedule')) || {};
        let sessions = JSON.parse(localStorage.getItem('nidoSessions')) || [];
        let currentWeekOffset = 0;
        let selectedSlot = null;

        const timeSlots = [
            { id: 1, time: '8:15-9:00' },
            { id: 2, time: '1:40-2:25' },
            { id: 3, time: '2:25-3:10' },
            { id: 4, time: '3:10-3:55' },
            { id: 5, time: '3:55-4:40' }
        ];

        const days = ['E H√´n√´', 'E Mart√´', 'E M√´rkur√´', 'E Enjte', 'E Premte'];

        const clientColors = [
            '#FF6B9D', '#9C27B0', '#2196F3', '#4CAF50', '#FF9800',
            '#E91E63', '#673AB7', '#3F51B5', '#009688', '#FFC107',
            '#F44336', '#8BC34A', '#00BCD4', '#CDDC39', '#795548'
        ];

        document.addEventListener('DOMContentLoaded', function () {
            renderSchedule();
            renderScheduleClients();
            renderAllClients();
            updateScheduleStats();
            updateCurrentWeek();
            renderSessions();
            renderPayments();
            renderDashboard();
            updateClientDropdowns();
        });

        function getWeekKey() {
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay() + 1 + (currentWeekOffset * 7));
            return weekStart.toISOString().split('T')[0];
        }

        function updateCurrentWeek() {
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay() + 1 + (currentWeekOffset * 7));
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 4);

            const formatDate = (date) => `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
            document.getElementById('currentWeek').textContent = `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;
        }

        function previousWeek() {
            currentWeekOffset--;
            updateCurrentWeek();
            renderSchedule();
        }

        function nextWeek() {
            currentWeekOffset++;
            updateCurrentWeek();
            renderSchedule();
        }

        function renderSchedule() {
            const grid = document.getElementById('scheduleGrid');
            const weekKey = getWeekKey();

            if (!weeklySchedule[weekKey]) {
                weeklySchedule[weekKey] = {};
            }

            let html = '<div></div>';

            days.forEach(day => {
                html += `<div class="day-header">${day}</div>`;
            });

            timeSlots.forEach(slot => {
                html += `<div class="time-label">${slot.time}</div>`;

                days.forEach((day, dayIndex) => {
                    const slotKey = `${dayIndex}-${slot.id}`;
                    const assignment = weeklySchedule[weekKey][slotKey];

                    if (assignment) {
                        const client = scheduleClients.find(c => c.id === assignment.clientId);
                        const color = client ? client.color : '#FF6B9D';
                        html += `
                            <div class="time-slot occupied" 
                                 style="background: linear-gradient(135deg, ${color} 0%, ${adjustColor(color, -20)} 100%);" 
                                 onclick="removeAssignment('${slotKey}')"
                                 draggable="true"
                                 ondragstart="handleDragStart(event, '${slotKey}')"
                                 ondragover="handleDragOver(event)"
                                 ondrop="handleDrop(event, '${slotKey}')">
                                <span class="slot-client-name">${assignment.clientName}</span>
                                <button class="slot-remove" onclick="event.stopPropagation(); removeAssignment('${slotKey}')">√ó</button>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="time-slot" 
                                 onclick="openAssignModal('${slotKey}')"
                                 ondragover="handleDragOver(event)"
                                 ondragleave="handleDragLeave(event)"
                                 ondrop="handleDrop(event, '${slotKey}')">
                                <span style="color: var(--text-light); font-size: 0.9em;">+</span>
                            </div>
                        `;
                    }
                });
            });

            grid.innerHTML = html;
            updateScheduleStats();
        }

        function adjustColor(color, amount) {
            return '#' + color.replace(/^#/, '').replace(/../g, color => ('0' + Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2));
        }

        function openAssignModal(slotKey) {
            selectedSlot = slotKey;
            const select = document.getElementById('clientSelect');

            select.innerHTML = '<option value="">-- Zgjidh --</option>';
            scheduleClients.forEach(client => {
                select.innerHTML += `<option value="${client.id}">${client.name}</option>`;
            });

            document.getElementById('assignClientModal').classList.add('active');
        }

        function assignClient() {
            const clientId = parseInt(document.getElementById('clientSelect').value);
            if (!clientId || !selectedSlot) return;

            const client = scheduleClients.find(c => c.id === clientId);
            const weekKey = getWeekKey();

            if (!weeklySchedule[weekKey]) {
                weeklySchedule[weekKey] = {};
            }

            weeklySchedule[weekKey][selectedSlot] = {
                clientId: client.id,
                clientName: client.name
            };

            saveSchedule();
            renderSchedule();
            closeModal('assignClientModal');
            showNotification(`${client.name} u caktua!`, 'success');
        }

        function removeAssignment(slotKey) {
            const weekKey = getWeekKey();
            if (weeklySchedule[weekKey] && weeklySchedule[weekKey][slotKey]) {
                delete weeklySchedule[weekKey][slotKey];
                saveSchedule();
                renderSchedule();
                showNotification('Hap√´sira u lirua!', 'success');
            }
        }

        // Drag and Drop Handlers
        function handleDragStart(event, slotKey) {
            event.dataTransfer.setData('text/plain', slotKey);
            event.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            if (!event.currentTarget.classList.contains('occupied')) {
                event.currentTarget.classList.add('drag-over');
            }
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(event, targetSlotKey) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            const sourceSlotKey = event.dataTransfer.getData('text/plain');
            if (sourceSlotKey === targetSlotKey) return;

            const weekKey = getWeekKey();
            if (!weeklySchedule[weekKey][sourceSlotKey]) return;

            // If target is occupied, don't allow drop (or we could swap, but let's keep it simple first)
            if (weeklySchedule[weekKey][targetSlotKey]) {
                showNotification('Hap√´sira √´sht√´ e z√´n√´!', 'warning');
                return;
            }

            // Move assignment
            const assignment = weeklySchedule[weekKey][sourceSlotKey];
            weeklySchedule[weekKey][targetSlotKey] = { ...assignment };
            delete weeklySchedule[weekKey][sourceSlotKey];

            // Update associated session record if it exists
            updateSessionOnMove(assignment.clientId, sourceSlotKey, targetSlotKey);

            saveSchedule();
            saveSessions();
            renderSchedule();
            renderSessions();
            showNotification('Seanca u l√´viz!', 'success');
        }

        function updateSessionOnMove(clientId, sourceKey, targetKey) {
            const [sourceDayIndex, sourceSlotId] = sourceKey.split('-').map(Number);
            const [targetDayIndex, targetSlotId] = targetKey.split('-').map(Number);

            const sourceTime = timeSlots.find(ts => ts.id === sourceSlotId).time.split('-')[0];
            const targetTimeSlot = timeSlots.find(ts => ts.id === targetSlotId);
            const targetTime = targetTimeSlot.time.split('-')[0];

            // Calculate dates
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay() + 1 + (currentWeekOffset * 7));

            const sourceDate = new Date(weekStart);
            sourceDate.setDate(weekStart.getDate() + sourceDayIndex);
            const sourceDateStr = sourceDate.toISOString().split('T')[0];

            const targetDate = new Date(weekStart);
            targetDate.setDate(weekStart.getDate() + targetDayIndex);
            const targetDateStr = targetDate.toISOString().split('T')[0];

            // Find the session that matches this client, date, and time
            const sessionIndex = sessions.findIndex(s =>
                s.clientId === clientId &&
                s.date === sourceDateStr &&
                s.time === sourceTime
            );

            if (sessionIndex !== -1) {
                sessions[sessionIndex].date = targetDateStr;
                sessions[sessionIndex].time = targetTime;
                sessions[sessionIndex].notes = (sessions[sessionIndex].notes || '') + ' (L√´vizur n√´ kalendar)';
            }
        }

        function autoSchedule() {
            const weekKey = getWeekKey();

            // Calculate previous week key
            const today = new Date();
            const prevWeekStart = new Date(today);
            prevWeekStart.setDate(today.getDate() - today.getDay() + 1 + ((currentWeekOffset - 1) * 7));
            const prevWeekKey = prevWeekStart.toISOString().split('T')[0];

            let useCopyMode = false;
            if (weeklySchedule[prevWeekKey] && Object.keys(weeklySchedule[prevWeekKey]).length > 0) {
                if (confirm('U gjet nj√´ orar nga java e kaluar. D√´shironi ta kopjoni at√´? (Kliko Cancel p√´r t√´ gjeneruar rast√´sisht)')) {
                    useCopyMode = true;
                }
            }

            if (!confirm(useCopyMode ? 'Kjo do t√´ kopjoj√´ orarin e jav√´s s√´ kaluar n√´ k√´t√´ jav√´. Vazhdo?' : 'Kjo do t√´ gjeneroj√´ nj√´ orar t√´ ri rast√´sor. Vazhdo?')) return;

            weeklySchedule[weekKey] = {};

            // Calculate start of the week for date generation
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay() + 1 + (currentWeekOffset * 7));

            // Remove existing sessions for this week range to avoid duplicates
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 4);

            const weekStartStr = weekStart.toISOString().split('T')[0];
            const weekEndStr = weekEnd.toISOString().split('T')[0];

            sessions = sessions.filter(s => {
                return s.date < weekStartStr || s.date > weekEndStr;
            });

            if (useCopyMode) {
                // COPY MODE
                Object.keys(weeklySchedule[prevWeekKey]).forEach(slotKey => {
                    const assignment = weeklySchedule[prevWeekKey][slotKey];
                    weeklySchedule[weekKey][slotKey] = { ...assignment };

                    // Parse slotKey (dayIndex-slotId)
                    const [dayIndex, slotId] = slotKey.split('-').map(Number);

                    // Generate Session Record
                    const sessionDate = new Date(weekStart);
                    sessionDate.setDate(weekStart.getDate() + dayIndex);
                    const dateStr = sessionDate.toISOString().split('T')[0];

                    const timeSlot = timeSlots.find(ts => ts.id === slotId);

                    const newSession = {
                        id: Date.now() + Math.random(),
                        clientId: assignment.clientId,
                        date: dateStr,
                        time: timeSlot ? timeSlot.time.split('-')[0] : '00:00',
                        price: 15,
                        notes: 'Kopjuar nga java e kaluar',
                        paid: false
                    };
                    sessions.push(newSession);
                });
                showNotification('Orari u kopjua nga java e kaluar!', 'success');
            } else {
                // RANDOM GENERATION MODE (Existing Logic)
                const allSlots = [];
                for (let dayIndex = 0; dayIndex < days.length; dayIndex++) {
                    for (let slotIndex = 0; slotIndex < timeSlots.length; slotIndex++) {
                        allSlots.push({
                            key: `${dayIndex}-${timeSlots[slotIndex].id}`,
                            day: dayIndex,
                            slot: slotIndex
                        });
                    }
                }

                // Shuffle
                for (let i = allSlots.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allSlots[i], allSlots[j]] = [allSlots[j], allSlots[i]];
                }

                let slotIndex = 0;

                scheduleClients.forEach(client => {
                    const sessionsToAssign = client.sessionsPerWeek;
                    let assigned = 0;
                    const usedDays = new Set();

                    while (assigned < sessionsToAssign && slotIndex < allSlots.length) {
                        const slot = allSlots[slotIndex];

                        if (!usedDays.has(slot.day) || usedDays.size >= days.length) {
                            weeklySchedule[weekKey][slot.key] = {
                                clientId: client.id,
                                clientName: client.name
                            };

                            const sessionDate = new Date(weekStart);
                            sessionDate.setDate(weekStart.getDate() + slot.day);
                            const dateStr = sessionDate.toISOString().split('T')[0];

                            const newSession = {
                                id: Date.now() + Math.random(),
                                clientId: client.id,
                                date: dateStr,
                                time: timeSlots[slot.slot].time.split('-')[0],
                                price: 15,
                                notes: 'Planifikuar Automatikisht',
                                paid: false
                            };
                            sessions.push(newSession);

                            usedDays.add(slot.day);
                            assigned++;
                        }
                        slotIndex++;
                    }
                });
                showNotification('Orari u gjenerua automatikisht!', 'success');
            }

            saveSchedule();
            saveSessions();
            renderSchedule();
            renderSessions();
            renderPayments();
        }

        function clearSchedule() {
            if (confirm('Fshi orarin dhe seancat e k√´saj jave?')) {
                const weekKey = getWeekKey();
                weeklySchedule[weekKey] = {};

                // Also clear sessions for this week
                const today = new Date();
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay() + 1 + (currentWeekOffset * 7));
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 4);

                const weekStartStr = weekStart.toISOString().split('T')[0];
                const weekEndStr = weekEnd.toISOString().split('T')[0];

                sessions = sessions.filter(s => {
                    return s.date < weekStartStr || s.date > weekEndStr;
                });

                saveSchedule();
                saveSessions();
                renderSchedule();
                renderSessions();
                renderPayments();
                showNotification('Orari dhe seancat u pastruan!', 'success');
            }
        }

        function updateScheduleStats() {
            const weekKey = getWeekKey();
            const totalSlots = days.length * timeSlots.length;
            const occupied = weeklySchedule[weekKey] ? Object.keys(weeklySchedule[weekKey]).length : 0;
            const free = totalSlots - occupied;
            const utilization = Math.round((occupied / totalSlots) * 100);

            document.getElementById('totalSlots').textContent = totalSlots;
            document.getElementById('occupiedSlots').textContent = occupied;
            document.getElementById('freeSlots').textContent = free;
            document.getElementById('utilization').textContent = utilization + '%';
        }

        function renderScheduleClients() {
            const container = document.getElementById('scheduleClientsList');
            const weekKey = getWeekKey();

            container.innerHTML = scheduleClients.map(client => {
                const scheduledCount = weeklySchedule[weekKey] ?
                    Object.values(weeklySchedule[weekKey]).filter(a => a.clientId === client.id).length : 0;

                return `
                    <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid ${client.color}; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 30px; height: 30px; border-radius: 50%; background: ${client.color};"></div>
                            <span style="font-weight: 600;">${client.name}</span>
                            <span style="background: ${client.color}; color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.9em;">${client.sessionsPerWeek}x</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color: var(--text-medium);">${scheduledCount}/${client.sessionsPerWeek}</span>
                            <button class="btn btn-danger btn-small" onclick="deleteScheduleClient(${client.id})">Fshi</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openAddScheduleClientModal() {
            document.getElementById('scheduleClientForm').reset();
            document.getElementById('addScheduleClientModal').classList.add('active');
        }

        document.getElementById('scheduleClientForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const colorIndex = scheduleClients.length % clientColors.length;
            const client = {
                id: Date.now(),
                name: document.getElementById('scheduleClientName').value,
                sessionsPerWeek: parseInt(document.getElementById('scheduleClientSessions').value),
                color: clientColors[colorIndex]
            };

            scheduleClients.push(client);
            saveScheduleClients();

            closeModal('addScheduleClientModal');
            closeModal('addScheduleClientModal');
            renderScheduleClients();
            renderAllClients();
            updateClientDropdowns();
            showNotification('Klienti u shtua!', 'success');
        });

        function deleteScheduleClient(clientId) {
            if (confirm('Fshi k√´t√´ klient?')) {
                scheduleClients = scheduleClients.filter(c => c.id !== clientId);

                Object.keys(weeklySchedule).forEach(weekKey => {
                    Object.keys(weeklySchedule[weekKey]).forEach(slotKey => {
                        if (weeklySchedule[weekKey][slotKey].clientId === clientId) {
                            delete weeklySchedule[weekKey][slotKey];
                        }
                    });
                });

                saveScheduleClients();
                saveSchedule();
                saveSchedule();
                renderScheduleClients();
                renderAllClients();
                renderSchedule();
                showNotification('Klienti u fshi!', 'success');
            }
        }

        // Sessions
        function openAddSessionModal() {
            if (scheduleClients.length === 0) {
                alert('Shtoni s√´ pari nj√´ klient n√´ orar.');
                return;
            }
            document.getElementById('sessionForm').reset();
            document.getElementById('sessionDate').valueAsDate = new Date();
            document.querySelector('.price-option').classList.add('selected');
            document.getElementById('addSessionModal').classList.add('active');
        }

        function selectPrice(price) {
            document.querySelectorAll('.price-option').forEach(opt => opt.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }

        document.getElementById('sessionForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const session = {
                id: Date.now(),
                clientId: parseInt(document.getElementById('sessionClient').value),
                date: document.getElementById('sessionDate').value,
                time: document.getElementById('sessionTime').value,
                price: parseFloat(document.querySelector('input[name="sessionPrice"]:checked').value),
                notes: document.getElementById('sessionNotes').value,
                paid: document.getElementById('sessionPaid').checked
            };

            sessions.push(session);
            saveSessions();

            closeModal('addSessionModal');
            renderSessions();
            renderPayments();
            showNotification('Seanca u shtua!', 'success');
        });

        function renderSessions() {
            const container = document.getElementById('sessionsList');

            if (sessions.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-light);">Nuk ka seanca</p>';
                return;
            }

            const sorted = [...sessions].sort((a, b) => new Date(b.date) - new Date(a.date));

            container.innerHTML = sorted.map(session => {
                const client = scheduleClients.find(c => c.id === session.clientId);
                return `
                    <div style="background: var(--bg-light); padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid ${client ? client.color : '#00BCD4'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-weight: 600; font-size: 1.1em; color: var(--primary-color);">${new Date(session.date).toLocaleDateString()} n√´ ${session.time}</span>
                            <span class="badge ${session.paid ? 'badge-paid' : 'badge-unpaid'}">${session.paid ? 'Paguar' : 'Papaguar'}</span>
                        </div>
                        <p><strong>Klienti:</strong> ${client ? client.name : 'I panjohur'}</p>
                        <p><strong>√ámimi:</strong> ‚Ç¨${session.price.toFixed(2)}</p>
                        <p><strong>Sh√´nime:</strong> ${session.notes || 'Nuk ka'}</p>
                        ${!session.paid ? `<button class="btn btn-success btn-small" onclick="markSessionPaid(${session.id})" style="margin-top: 10px;">Sh√´no si Paguar</button>` : ''}
                    </div>
                `;
            }).join('');
        }

        function markSessionPaid(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (session) {
                session.paid = true;
                saveSessions();
                renderSessions();
                renderPayments();
                showNotification('Seanca u sh√´nua si e paguar!', 'success');
            }
        }

        // Payments
        function renderPayments() {
            const container = document.getElementById('paymentsList');

            if (scheduleClients.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-light);">Nuk ka t√´ dh√´na</p>';
                return;
            }

            const totalCollected = sessions.filter(s => s.paid).reduce((sum, s) => sum + s.price, 0);
            const totalOutstanding = sessions.filter(s => !s.paid).reduce((sum, s) => sum + s.price, 0);
            const clientsWithDebt = scheduleClients.filter(c => {
                const clientSessions = sessions.filter(s => s.clientId === c.id && !s.paid);
                return clientSessions.length > 0;
            }).length;

            document.getElementById('totalCollected').textContent = `‚Ç¨${totalCollected.toFixed(2)}`;
            document.getElementById('totalOutstanding').textContent = `‚Ç¨${totalOutstanding.toFixed(2)}`;
            document.getElementById('clientsWithDebt').textContent = clientsWithDebt;

            container.innerHTML = scheduleClients.map(client => {
                const clientSessions = sessions.filter(s => s.clientId === client.id);
                if (clientSessions.length === 0) return '';

                const totalOwed = clientSessions.reduce((sum, s) => sum + s.price, 0);
                const totalPaid = clientSessions.filter(s => s.paid).reduce((sum, s) => sum + s.price, 0);
                const balance = totalOwed - totalPaid;

                return `
                    <div class="payment-card ${balance > 0 ? 'overdue' : ''}" style="border-left-color: ${client.color};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: var(--text-dark);">${client.name}</h3>
                            <button class="btn btn-primary btn-small" onclick="generateInvoice(${client.id})">üìÑ Fatur√´</button>
                        </div>
                        
                        <div class="payment-summary">
                            <div class="payment-summary-item">
                                <h4>‚Ç¨${totalOwed.toFixed(2)}</h4>
                                <p>Totali</p>
                            </div>
                            <div class="payment-summary-item paid">
                                <h4>‚Ç¨${totalPaid.toFixed(2)}</h4>
                                <p>Paguar</p>
                            </div>
                            <div class="payment-summary-item ${balance > 0 ? 'debt' : ''}">
                                <h4>‚Ç¨${balance.toFixed(2)}</h4>
                                <p>Borxh</p>
                            </div>
                        </div>
                    </div>
                `;
            }).filter(Boolean).join('');
        }

        function generateInvoice(clientId) {
            const client = scheduleClients.find(c => c.id === clientId);
            const clientSessions = sessions.filter(s => s.clientId === clientId);

            const totalOwed = clientSessions.reduce((sum, s) => sum + s.price, 0);
            const totalPaid = clientSessions.filter(s => s.paid).reduce((sum, s) => sum + s.price, 0);
            const balance = totalOwed - totalPaid;

            const today = new Date().toLocaleDateString();
            const invoiceNumber = `FAT-${Date.now()}`;

            document.getElementById('invoiceContent').innerHTML = `
                <div class="invoice-container">
                    <div class="invoice-header-row">
                        <div class="invoice-from">
                            <img src="logo.png" alt="Logo" class="invoice-logo">
                            <h3 style="margin: 10px 0; color: var(--text-dark);">Nido Clinic</h3>
                            <p style="font-size: 0.9em; color: #666;">Platforma e Terapis√´ s√´ t√´ Folurit</p>
                            <p style="font-size: 0.9em; color: #666;">Rr. Kryesore, Prishtin√´</p>
                        </div>
                        <div class="invoice-title">
                            <h1>Fatur√´</h1>
                            <div class="invoice-meta">
                                <p><strong>Nr:</strong> ${invoiceNumber}</p>
                                <p><strong>Data:</strong> ${today}</p>
                            </div>
                        </div>
                    </div>

                    <div class="invoice-grid">
                        <div class="invoice-to">
                            <div class="invoice-subtitle">Faturuar P√´r:</div>
                            <h3 style="margin: 5px 0; color: var(--primary-dark);">${client.name}</h3>
                            <p style="font-size: 0.9em; color: #666;">Klient i rregullt</p>
                            <p style="font-size: 0.9em; color: #666;">Seanca Javore: ${client.sessionsPerWeek}</p>
                        </div>
                    </div>

                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th>P√´rshkrimi</th>
                                <th>Data</th>
                                <th>Ora</th>
                                <th>Statusi</th>
                                <th style="text-align: right;">Shuma</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${clientSessions.sort((a, b) => new Date(a.date) - new Date(b.date)).map(s => `
                                <tr>
                                    <td>Seanc√´ Terapie</td>
                                    <td>${new Date(s.date).toLocaleDateString()}</td>
                                    <td>${s.time}</td>
                                    <td>${s.paid ? 'Paguar' : 'Pa Paguar'}</td>
                                    <td style="text-align: right;">‚Ç¨${s.price.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="invoice-summary">
                        <div class="invoice-totals">
                            <div class="total-row">
                                <span>N√´ntotali:</span>
                                <span>‚Ç¨${totalOwed.toFixed(2)}</span>
                            </div>
                            <div class="total-row">
                                <span>Paguar (-):</span>
                                <span>‚Ç¨${totalPaid.toFixed(2)}</span>
                            </div>
                            <div class="total-row final">
                                <span>Detyrimi Total:</span>
                                <span>‚Ç¨${balance.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>

                    <div class="invoice-footer">
                        <p>Faleminderit p√´r besimin tuaj!</p>
                        <p>Ju lutem kryeni pages√´n brenda afatit t√´ caktuar.</p>
                    </div>
                    
                    <div class="invoice-actions" style="margin-top: 30px; text-align: center;">
                        <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Printo Fatur√´n</button>
                        <button class="btn btn-warning" onclick="document.getElementById('invoiceModal').classList.remove('active')">Mbyll</button>
                    </div>
                </div>
            `;

            document.getElementById('invoiceModal').classList.add('active');
        }

        function filterPayments() {
            const search = document.getElementById('paymentSearch').value.toLowerCase();
            document.querySelectorAll('.payment-card').forEach(card => {
                card.style.display = card.textContent.toLowerCase().includes(search) ? 'block' : 'none';
            });
        }

        function updateClientDropdowns() {
            const select = document.getElementById('sessionClient');
            select.innerHTML = '<option value="">-- Zgjidh --</option>' +
                scheduleClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

            document.getElementById(viewId).classList.add('active');

            // Find the nav item that corresponds to this view (approximate match by onclick content)
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (item.getAttribute('onclick').includes(viewId)) {
                    item.classList.add('active');
                }
            });

            if (viewId === 'dashboard') {
                renderDashboard();
            }
        }

        function saveSchedule() {
            localStorage.setItem('weeklySchedule', JSON.stringify(weeklySchedule));
        }

        function saveScheduleClients() {
            localStorage.setItem('scheduleClients', JSON.stringify(scheduleClients));
        }

        function saveSessions() {
            localStorage.setItem('nidoSessions', JSON.stringify(sessions));
        }

        function exportData() {
            const data = {
                scheduleClients: scheduleClients,
                weeklySchedule: weeklySchedule,
                sessions: sessions,
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `nido-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            showNotification('T√´ dh√´nat u eksportuan!', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (confirm('Z√´vend√´so t√´ dh√´nat?')) {
                        scheduleClients = data.scheduleClients || [];
                        weeklySchedule = data.weeklySchedule || {};
                        sessions = data.sessions || [];

                        saveScheduleClients();
                        saveSchedule();
                        saveSessions();

                        renderSchedule();
                        renderScheduleClients();
                        renderAllClients();
                        renderSessions();
                        renderPayments();
                        updateClientDropdowns();

                        showNotification('T√´ dh√´nat u importuan!', 'success');
                    }
                } catch (error) {
                    alert('Gabim n√´ import!');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function renderAllClients() {
            const container = document.getElementById('allClientsList');

            if (scheduleClients.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-light);">Nuk ka klient√´ t√´ regjistruar</p>';
                return;
            }

            container.innerHTML = scheduleClients.map(client => {
                // Determine if active based on whether they have any sessions in the system schedule or history
                const totalSessions = sessions.filter(s => s.clientId === client.id).length;

                return `
                    <div style="background: white; padding: 20px; margin-bottom: 15px; border-radius: 12px; border-left: 5px solid ${client.color}; box-shadow: var(--shadow-medium); display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            ${client.photo ? `
                                <img src="${client.photo}" class="client-avatar-small">
                            ` : `
                                <div style="width: 50px; height: 50px; border-radius: 50%; background: ${client.color}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2em;">
                                    ${client.name.substring(0, 1).toUpperCase()}
                                </div>
                            `}
                            <div>
                                <h3 style="margin-bottom: 5px; color: var(--text-dark);">${client.name}</h3>
                                <div style="display: flex; gap: 10px; font-size: 0.9em; color: var(--text-medium);">
                                    <span>üóìÔ∏è ${client.sessionsPerWeek} seanca/jav√´</span>
                                    <span>üìä ${totalSessions} seanca total</span>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                             <button class="btn btn-primary btn-small" onclick="openClientProfile(${client.id})">üë§ Profili</button>
                             <button class="btn btn-danger btn-small" onclick="deleteScheduleClient(${client.id})">Fshi</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderDashboard() {
            const container = document.getElementById('dashboardContent');
            const weekKey = getWeekKey();

            // Calculate stats
            const sessionsThisWeek = weeklySchedule[weekKey] ? Object.keys(weeklySchedule[weekKey]).length : 0;
            const weekSessions = sessions.filter(s => {
                const sessionDate = new Date(s.date);
                const today = new Date();
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay() + 1 + (currentWeekOffset * 7));
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 4);

                const sDate = s.date;
                const wStart = weekStart.toISOString().split('T')[0];
                const wEnd = weekEnd.toISOString().split('T')[0];

                return sDate >= wStart && sDate <= wEnd;
            });

            const projectedIncome = weekSessions.reduce((sum, s) => sum + s.price, 0);
            const activeClients = scheduleClients.filter(c => sessions.some(s => s.clientId === c.id)).length;

            // Upcoming sessions (future sessions from now)
            const now = new Date();
            const upcomingSessions = sessions
                .filter(s => new Date(s.date + 'T' + s.time) > now)
                .sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time))
                .slice(0, 5);

            // Financial Health
            const totalOutstanding = sessions.filter(s => !s.paid).reduce((sum, s) => sum + s.price, 0);

            const clientDebts = scheduleClients.map(c => {
                const debt = sessions
                    .filter(s => s.clientId === c.id && !s.paid)
                    .reduce((sum, s) => sum + s.price, 0);
                return { ...c, debt };
            })
                .filter(c => c.debt > 0)
                .sort((a, b) => b.debt - a.debt)
                .slice(0, 3);

            container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card dark-bg" style="background: linear-gradient(135deg, #673AB7 0%, #512DA8 100%); color: white;">
                        <h3 style="color: white;">${sessionsThisWeek}</h3>
                        <p style="color: rgba(255,255,255,0.8);">Seanca K√´t√´ Jav√´</p>
                    </div>
                    <div class="stat-card success">
                        <h3>‚Ç¨${projectedIncome.toFixed(0)}</h3>
                        <p>T√´ Ardhurat (Java)</p>
                    </div>
                    <div class="stat-card accent">
                        <h3>${activeClients}</h3>
                        <p>Klient√´ Aktiv√´</p>
                    </div>
                    <div class="stat-card warning">
                        <h3>‚Ç¨${totalOutstanding.toFixed(0)}</h3>
                        <p>Borxhi Total</p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px;">
                    <div style="background: white; padding: 25px; border-radius: var(--border-radius-large); box-shadow: var(--shadow-medium);">
                        <h3 style="color: var(--text-dark); margin-bottom: 20px; border-bottom: 2px solid #F5F5F5; padding-bottom: 10px;">
                            üìÖ Seancat e Ardhshme
                        </h3>
                        ${upcomingSessions.length > 0 ? upcomingSessions.map(s => {
                const client = scheduleClients.find(c => c.id === s.clientId);
                return `
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #EEEEEE;">
                                    <div style="display: flex; align-items: center; gap: 15px;">
                                        <div style="background: ${client ? client.color : '#ccc'}; color: white; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                            ${new Date(s.date).getDate()}
                                        </div>
                                        <div>
                                            <div style="font-weight: 600; color: var(--text-dark);">${client ? client.name : 'Unknown'}</div>
                                            <div style="font-size: 0.9em; color: var(--text-medium);">${s.time} ‚Ä¢ ${s.price}‚Ç¨</div>
                                        </div>
                                    </div>
                                    <span class="badge ${s.paid ? 'badge-paid' : 'badge-unpaid'}">${s.paid ? 'Paguar' : 'Pa Paguar'}</span>
                                </div>
                            `;
            }).join('') : '<p style="color: var(--text-medium); text-align: center;">Nuk ka seanca t√´ ardhshme</p>'}
                        <button class="btn btn-primary btn-small" style="width: 100%; margin-top: 10px;" onclick="showView('schedule')">Shiko Orarin e Plot√´</button>
                    </div>

                    <div style="background: white; padding: 25px; border-radius: var(--border-radius-large); box-shadow: var(--shadow-medium);">
                        <h3 style="color: var(--text-dark); margin-bottom: 20px; border-bottom: 2px solid #F5F5F5; padding-bottom: 10px;">
                            ‚ö†Ô∏è Borxhet Kryesore
                        </h3>
                        ${clientDebts.length > 0 ? clientDebts.map(c => `
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding: 10px; background: var(--bg-light); border-radius: 10px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 10px; height: 10px; border-radius: 50%; background: ${c.color};"></div>
                                    <span style="font-weight: 600;">${c.name}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-weight: bold; color: var(--danger-color);">‚Ç¨${c.debt.toFixed(2)}</span>
                                    <button class="btn btn-secondary btn-small" onclick="showView('payments'); document.getElementById('paymentSearch').value = '${c.name}'; filterPayments();">Shiko</button>
                                </div>
                            </div>
                        `).join('') : '<p style="color: var(--success-color); text-align: center;">Shk√´lqyesh√´m! Nuk ka borxhe madhore.</p>'}
                    </div>
                </div>

                <div style="margin-top: 30px; background: white; padding: 25px; border-radius: var(--border-radius-large); box-shadow: var(--shadow-medium);">
                    <h3 style="color: var(--text-dark); margin-bottom: 20px;">‚ö° Veprime t√´ Shpejta</h3>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                         <button class="btn btn-primary" onclick="openAddScheduleClientModal()">
                            üë• Shto Klient t√´ Ri
                        </button>
                         <button class="btn btn-success" onclick="openAddSessionModal()">
                            üìù Shto Seanc√´
                        </button>
                         <button class="btn btn-warning" onclick="showView('payments')">
                            üí∞ Menaxho Pagesat
                        </button>
                    </div>
                </div>
            `;
        }

        // Client Profile Functions
        let currentProfileClientId = null;
        let currentProfileTab = 'basic';

        function openClientProfile(clientId) {
            currentProfileClientId = clientId;
            currentProfileTab = 'basic';

            // Ensure client has extended fields
            const client = scheduleClients.find(c => c.id === clientId);
            if (!client.phone) client.phone = '';
            if (!client.email) client.email = '';
            if (!client.dateOfBirth) client.dateOfBirth = '';
            if (!client.parentGuardian) client.parentGuardian = '';
            if (!client.diagnosis) client.diagnosis = '';
            if (!client.therapyGoals) client.therapyGoals = '';
            if (!client.specialNeeds) client.specialNeeds = '';
            if (!client.allergies) client.allergies = '';
            if (!client.progressNotes) client.progressNotes = [];
            if (!client.photo) client.photo = null;

            updateProfileHeader(client);

            document.getElementById('clientProfileModal').classList.add('active');
            switchProfileTab('basic');
        }

        function updateProfileHeader(client) {
            const initial = document.getElementById('profile-picture-initial');
            const display = document.getElementById('profile-picture-display');

            if (client.photo) {
                if (initial) initial.style.display = 'none';
                if (display) {
                    display.src = client.photo;
                    display.style.display = 'block';
                }
            } else {
                if (initial) {
                    initial.textContent = client.name ? client.name.substring(0, 1).toUpperCase() : '?';
                    initial.style.display = 'block';
                }
                if (display) display.style.display = 'none';
            }
        }

        function switchProfileTab(tabName) {
            currentProfileTab = tabName;

            // Update tab buttons
            document.querySelectorAll('.profile-tab').forEach(tab => tab.classList.remove('active'));
            event?.target?.classList.add('active');

            // Render tab content
            const client = scheduleClients.find(c => c.id === currentProfileClientId);
            const content = document.getElementById('profileTabContent');

            if (tabName === 'basic') {
                content.innerHTML = `
                    <div class="profile-section">
                        <h3 style="color: var(--primary-color); margin-bottom: 20px;">Informacion Baz√´</h3>
                        <div class="profile-form-grid">
                            <div class="profile-form-group">
                                <label>Emri i Plot√´ *</label>
                                <input type="text" id="profile-name" value="${client.name}" required>
                            </div>
                            <div class="profile-form-group">
                                <label>Telefon</label>
                                <input type="tel" id="profile-phone" value="${client.phone || ''}">
                            </div>
                            <div class="profile-form-group">
                                <label>Email</label>
                                <input type="email" id="profile-email" value="${client.email || ''}">
                            </div>
                            <div class="profile-form-group">
                                <label>Dat√´lindja</label>
                                <input type="date" id="profile-dob" value="${client.dateOfBirth || ''}">
                            </div>
                            <div class="profile-form-group">
                                <label>Prind/Kujdestar</label>
                                <input type="text" id="profile-parent" value="${client.parentGuardian || ''}">
                            </div>
                            <div class="profile-form-group">
                                <label>Seanca n√´ Jav√´</label>
                                <input type="number" id="profile-sessions" value="${client.sessionsPerWeek}" min="1" max="7">
                            </div>
                            <div class="profile-form-group" style="grid-column: 1 / -1;">
                                <label>Foto e Profilit</label>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <button class="btn btn-secondary" onclick="document.getElementById('profile-photo-input').click()">üìÅ Ngarko Foto</button>
                                    <button class="btn btn-danger btn-small" onclick="removeProfilePhoto()">üóëÔ∏è Hiq foton</button>
                                    <input type="file" id="profile-photo-input" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
                                </div>
                                <p style="font-size: 0.8em; color: var(--text-medium); margin-top: 5px;">Rekomandohet foto katrore. Do t√´ kompresohet automatikisht.</p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (tabName === 'medical') {
                content.innerHTML = `
                    <div class="profile-section">
                        <h3 style="color: var(--primary-color); margin-bottom: 20px;">Informacion Mjek√´sor & Terapia</h3>
                        <div class="profile-form-grid">
                            <div class="profile-form-group" style="grid-column: 1 / -1;">
                                <label>Diagnoza</label>
                                <textarea id="profile-diagnosis">${client.diagnosis || ''}</textarea>
                            </div>
                            <div class="profile-form-group" style="grid-column: 1 / -1;">
                                <label>Q√´llimet e Terapis√´</label>
                                <textarea id="profile-goals">${client.therapyGoals || ''}</textarea>
                            </div>
                            <div class="profile-form-group" style="grid-column: 1 / -1;">
                                <label>Nevoja t√´ Ve√ßanta</label>
                                <textarea id="profile-needs">${client.specialNeeds || ''}</textarea>
                            </div>
                            <div class="profile-form-group" style="grid-column: 1 / -1;">
                                <label>Alergjit√´</label>
                                <textarea id="profile-allergies">${client.allergies || ''}</textarea>
                            </div>
                        </div>
                    </div>
                `;
            } else if (tabName === 'sessions') {
                const clientSessions = sessions.filter(s => s.clientId === currentProfileClientId);
                content.innerHTML = `
                    <div class="profile-section">
                        <h3 style="color: var(--primary-color); margin-bottom: 20px;">Historiku i Seancave (${clientSessions.length} total)</h3>
                        ${clientSessions.length > 0 ? `
                            <table class="session-history-table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Ora</th>
                                        <th>√ámimi</th>
                                        <th>Statusi</th>
                                        <th>Sh√´nime</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${clientSessions.sort((a, b) => new Date(b.date) - new Date(a.date)).map(s => `
                                        <tr>
                                            <td>${new Date(s.date).toLocaleDateString()}</td>
                                            <td>${s.time}</td>
                                            <td>‚Ç¨${s.price.toFixed(2)}</td>
                                            <td><span class="badge ${s.paid ? 'badge-paid' : 'badge-unpaid'}">${s.paid ? 'Paguar' : 'Papaguar'}</span></td>
                                            <td>${s.notes || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : '<p style="text-align: center; color: var(--text-medium); padding: 40px;">Nuk ka seanca t√´ regjistruara</p>'}
                    </div>
                `;
            } else if (tabName === 'payments') {
                const clientSessions = sessions.filter(s => s.clientId === currentProfileClientId);
                const totalOwed = clientSessions.reduce((sum, s) => sum + s.price, 0);
                const totalPaid = clientSessions.filter(s => s.paid).reduce((sum, s) => sum + s.price, 0);
                const balance = totalOwed - totalPaid;

                content.innerHTML = `
                    <div class="profile-section">
                        <h3 style="color: var(--primary-color); margin-bottom: 20px;">P√´rmbledhje e Pagesave</h3>
                        <div class="stats-grid" style="margin-bottom: 30px;">
                            <div class="stat-card">
                                <h3>‚Ç¨${totalOwed.toFixed(2)}</h3>
                                <p>Totali i Borxhit</p>
                            </div>
                            <div class="stat-card success">
                                <h3>‚Ç¨${totalPaid.toFixed(2)}</h3>
                                <p>Totali i Paguar</p>
                            </div>
                            <div class="stat-card ${balance > 0 ? 'warning' : 'success'}">
                                <h3>‚Ç¨${balance.toFixed(2)}</h3>
                                <p>Bilanci</p>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="generateInvoice(${currentProfileClientId})">üìÑ Gjenero Fatur√´</button>
                    </div>
                `;
            } else if (tabName === 'notes') {
                const notes = client.progressNotes || [];
                content.innerHTML = `
                    <div class="profile-section">
                        <h3 style="color: var(--primary-color); margin-bottom: 20px;">Sh√´nime t√´ Progresit</h3>
                        
                        <div class="add-note-form">
                            <h4 style="margin-bottom: 15px; color: var(--text-dark);">Shto Sh√´nim t√´ Ri</h4>
                            <textarea id="new-progress-note" placeholder="Shkruani sh√´nimin tuaj k√´tu..." style="width: 100%; min-height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; margin-bottom: 10px;"></textarea>
                            <button class="btn btn-success" onclick="addProgressNote()">‚ûï Shto Sh√´nim</button>
                        </div>

                        <div style="margin-top: 30px;">
                            <h4 style="margin-bottom: 15px; color: var(--text-dark);">Historiku i Sh√´nimeve</h4>
                            ${notes.length > 0 ? notes.sort((a, b) => new Date(b.date) - new Date(a.date)).map(note => `
                                <div class="progress-note">
                                    <div class="progress-note-date">üìÖ ${new Date(note.date).toLocaleDateString()} - ${new Date(note.date).toLocaleTimeString()}</div>
                                    <div class="progress-note-text">${note.note}</div>
                                </div>
                            `).join('') : '<p style="text-align: center; color: var(--text-medium); padding: 40px;">Nuk ka sh√´nime</p>'}
                        </div>
                    </div>
                `;
            }
        }

        function addProgressNote() {
            const noteText = document.getElementById('new-progress-note').value.trim();
            if (!noteText) {
                alert('Ju lutem shkruani nj√´ sh√´nim!');
                return;
            }

            const client = scheduleClients.find(c => c.id === currentProfileClientId);
            if (!client.progressNotes) client.progressNotes = [];

            client.progressNotes.push({
                id: Date.now(),
                date: new Date().toISOString(),
                note: noteText
            });

            saveScheduleClients();
            switchProfileTab('notes');
            showNotification('Sh√´nimi u shtua!', 'success');
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const img = new Image();
                img.onload = function () {
                    // Create canvas for compression
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 200;
                    const MAX_HEIGHT = 200;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Convert to low-quality JPEG to save space
                    const base64 = canvas.toDataURL('image/jpeg', 0.7);

                    const client = scheduleClients.find(c => c.id === currentProfileClientId);
                    client.photo = base64;

                    saveScheduleClients();
                    renderAllClients();
                    updateProfileHeader(client);
                    showNotification('Foto u ngarkua!', 'success');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function removeProfilePhoto() {
            if (confirm('Fshi foton e profilit?')) {
                const client = scheduleClients.find(c => c.id === currentProfileClientId);
                client.photo = null;
                saveScheduleClients();
                renderAllClients();
                updateProfileHeader(client);
                showNotification('Foto u hoq!', 'success');
            }
        }

        function saveClientProfile() {
            const client = scheduleClients.find(c => c.id === currentProfileClientId);

            if (currentProfileTab === 'basic') {
                client.name = document.getElementById('profile-name').value;
                client.phone = document.getElementById('profile-phone').value;
                client.email = document.getElementById('profile-email').value;
                client.dateOfBirth = document.getElementById('profile-dob').value;
                client.parentGuardian = document.getElementById('profile-parent').value;
                client.sessionsPerWeek = parseInt(document.getElementById('profile-sessions').value);
            } else if (currentProfileTab === 'medical') {
                client.diagnosis = document.getElementById('profile-diagnosis').value;
                client.therapyGoals = document.getElementById('profile-goals').value;
                client.specialNeeds = document.getElementById('profile-needs').value;
                client.allergies = document.getElementById('profile-allergies').value;
            }

            saveScheduleClients();
            renderAllClients();
            renderScheduleClients();
            updateClientDropdowns();
            showNotification('Profili u ruajt!', 'success');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type}`;
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '10000';
            notification.style.minWidth = '300px';

            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        window.onclick = function (event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered', reg))
                    .catch(err => console.log('Service Worker registration failed', err));
            });
        }
    </script>
</body>

</html>